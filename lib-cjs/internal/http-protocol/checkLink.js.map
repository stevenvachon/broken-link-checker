{"version":3,"file":"checkLink.js","names":["_lodash","require","_Link","_request","_interopRequireDefault","_urlRelation","obj","__esModule","default","copyResponseData","response","link","cacheResponses","code","status","url","Error","break","mend","URLRelation","match","get","REBASED_URL","targetComponent","PATH","redirect","cloneDeep","set","HTTP_RESPONSE","_default","auth","cache","options","requestMethod","result","undefined","HTTP_RESPONSE_WAS_CACHED","request","then","catch","error","exports","module"],"sources":["../../../lib/internal/http-protocol/checkLink.js"],"sourcesContent":["import {cloneDeep} from \"lodash\";\nimport {HTTP_RESPONSE, HTTP_RESPONSE_WAS_CACHED, REBASED_URL} from \"../Link\";\nimport request from \"./request\";\nimport URLRelation from \"url-relation\";\n\n\n\n/**\n * Copy data from a cached or uncached response into a Link.\n * @param {object|Error} response\n * @param {Link} link\n * @param {object} options\n */\nconst copyResponseData = (response, link, {cacheResponses}) =>\n{\n\tconst {code, status, url} = response;\n\n\tif (response instanceof Error)\n\t{\n\t\tlink.break(`ERRNO_${code}`);\n\t}\n\telse\n\t{\n\t\tif (status<200 || status>299)\n\t\t{\n\t\t\tlink.break(`HTTP_${status}`);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tlink.mend();\n\t\t}\n\n\t\t// @todo would a string check be sufficient?\n\t\tif (!URLRelation.match(url, link.get(REBASED_URL), { targetComponent:URLRelation.PATH }))\n\t\t{\n\t\t\t// @todo this needs a test\n\t\t\t// @todo test if redirected to a different protocol\n\t\t\tlink.redirect(url);\n\t\t}\n\n\t\tif (cacheResponses)\n\t\t{\n\t\t\t// Avoid potential mutations to cache\n\t\t\tresponse = cloneDeep(response);\n\t\t}\n\n\t\tlink.set(HTTP_RESPONSE, response);\n\t}\n};\n\n\n\n/**\n * Check a link's URL to see if it is broken or not.\n * @param {Link} link\n * @param {object} auth\n * @param {URLCache} cache\n * @param {object} options\n * @throws {TypeError} non-Link\n * @returns {Promise<Link>}\n */\nexport default async (link, auth, cache, options) =>\n{\n\tconst {cacheResponses, requestMethod} = options;\n\n\tif (cacheResponses)\n\t{\n\t\tconst result = cache.get(link.get(REBASED_URL));\n\n\t\tif (result !== undefined)\n\t\t{\n\t\t\tcopyResponseData(await result, link, options);\n\n\t\t\tlink.set(HTTP_RESPONSE_WAS_CACHED, true);\n\t\t}\n\t}\n\n\tif (link.get(HTTP_RESPONSE_WAS_CACHED) === null)\n\t{\n\t\tconst result = await request(link.get(REBASED_URL), auth, requestMethod, cache, options)\n\t\t.then(({response}) => response)  // exclude any stream\n\t\t.catch(error => error);\n\n\t\tcopyResponseData(result, link, options);\n\n\t\tlink.set(HTTP_RESPONSE_WAS_CACHED, false);\n\t}\n\n\treturn link;\n};\n"],"mappings":";;;;;;AAAA,IAAAA,OAAA,GAAAC,OAAA;AACA,IAAAC,KAAA,GAAAD,OAAA;AACA,IAAAE,QAAA,GAAAC,sBAAA,CAAAH,OAAA;AACA,IAAAI,YAAA,GAAAD,sBAAA,CAAAH,OAAA;AAAuC,SAAAG,uBAAAE,GAAA,WAAAA,GAAA,IAAAA,GAAA,CAAAC,UAAA,GAAAD,GAAA,KAAAE,OAAA,EAAAF,GAAA;AAIvC;AACA;AACA;AACA;AACA;AACA;AACA,MAAMG,gBAAgB,GAAGA,CAACC,QAAQ,EAAEC,IAAI,EAAE;EAACC;AAAc,CAAC,KAC1D;EACC,MAAM;IAACC,IAAI;IAAEC,MAAM;IAAEC;EAAG,CAAC,GAAGL,QAAQ;EAEpC,IAAIA,QAAQ,YAAYM,KAAK,EAC7B;IACCL,IAAI,CAACM,KAAK,CAAE,SAAQJ,IAAK,EAAC,CAAC;EAC5B,CAAC,MAED;IACC,IAAIC,MAAM,GAAC,GAAG,IAAIA,MAAM,GAAC,GAAG,EAC5B;MACCH,IAAI,CAACM,KAAK,CAAE,QAAOH,MAAO,EAAC,CAAC;IAC7B,CAAC,MAED;MACCH,IAAI,CAACO,IAAI,CAAC,CAAC;IACZ;;IAEA;IACA,IAAI,CAACC,oBAAW,CAACC,KAAK,CAACL,GAAG,EAAEJ,IAAI,CAACU,GAAG,CAACC,iBAAW,CAAC,EAAE;MAAEC,eAAe,EAACJ,oBAAW,CAACK;IAAK,CAAC,CAAC,EACxF;MACC;MACA;MACAb,IAAI,CAACc,QAAQ,CAACV,GAAG,CAAC;IACnB;IAEA,IAAIH,cAAc,EAClB;MACC;MACAF,QAAQ,GAAG,IAAAgB,iBAAS,EAAChB,QAAQ,CAAC;IAC/B;IAEAC,IAAI,CAACgB,GAAG,CAACC,mBAAa,EAAElB,QAAQ,CAAC;EAClC;AACD,CAAC;;AAID;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AARA,IAAAmB,QAAA,GASe,MAAAA,CAAOlB,IAAI,EAAEmB,IAAI,EAAEC,KAAK,EAAEC,OAAO,KAChD;EACC,MAAM;IAACpB,cAAc;IAAEqB;EAAa,CAAC,GAAGD,OAAO;EAE/C,IAAIpB,cAAc,EAClB;IACC,MAAMsB,MAAM,GAAGH,KAAK,CAACV,GAAG,CAACV,IAAI,CAACU,GAAG,CAACC,iBAAW,CAAC,CAAC;IAE/C,IAAIY,MAAM,KAAKC,SAAS,EACxB;MACC1B,gBAAgB,CAAC,MAAMyB,MAAM,EAAEvB,IAAI,EAAEqB,OAAO,CAAC;MAE7CrB,IAAI,CAACgB,GAAG,CAACS,8BAAwB,EAAE,IAAI,CAAC;IACzC;EACD;EAEA,IAAIzB,IAAI,CAACU,GAAG,CAACe,8BAAwB,CAAC,KAAK,IAAI,EAC/C;IACC,MAAMF,MAAM,GAAG,MAAM,IAAAG,gBAAO,EAAC1B,IAAI,CAACU,GAAG,CAACC,iBAAW,CAAC,EAAEQ,IAAI,EAAEG,aAAa,EAAEF,KAAK,EAAEC,OAAO,CAAC,CACvFM,IAAI,CAAC,CAAC;MAAC5B;IAAQ,CAAC,KAAKA,QAAQ,CAAC,CAAE;IAAA,CAChC6B,KAAK,CAACC,KAAK,IAAIA,KAAK,CAAC;IAEtB/B,gBAAgB,CAACyB,MAAM,EAAEvB,IAAI,EAAEqB,OAAO,CAAC;IAEvCrB,IAAI,CAACgB,GAAG,CAACS,8BAAwB,EAAE,KAAK,CAAC;EAC1C;EAEA,OAAOzB,IAAI;AACZ,CAAC;AAAA8B,OAAA,CAAAjC,OAAA,GAAAqB,QAAA;AAAAa,MAAA,CAAAD,OAAA,GAAAA,OAAA,CAAAjC,OAAA"}